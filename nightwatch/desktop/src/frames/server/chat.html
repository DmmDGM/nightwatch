<style>
    .server-parent {
        width: 100%;
        height: calc(100% - 20px);
        margin: 10px;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(5, 1fr);
        grid-column-gap: 10px;
        grid-row-gap: 10px;
    }
    .server-parent > div {
        padding: 20px;
        border-radius: 15px;
        background-color: var(--sd-black-d5);
    }
    #server-info {
        position: relative;
        grid-area: 1 / 4 / 3 / 5;
    }
    #server-members { grid-area: 3 / 4 / 6 / 5; }
    img.banner {
        top: 0px;
        left: 0px;
        position: absolute;
        width: 100%;
        height: 80px;
        object-fit: cover;
        border-radius: 15px 15px 0px 0px;
    }
    div.content {
        margin-top: 80px;
    }
    div.member {
        gap: 12px;
    }
    div.member p {
        font-size: 16px;
    }
    div.member span {
        font-size: 12px;
    }
    h1, h2, h3, h4, h5, h6, p {
        margin: 0px !important;
    }

    /* Message styling */
    #server-chat {
        padding: 0px;
        position: relative;
        grid-area: 1 / 1 / 6 / 4;
    }
    div.message-group {
        padding: 10px;
        position: relative;
        border-radius: 15px;
        background-color: var(--sd-black-d10);
    }
    div.message-group > img.icon {
        left: -45px;
        position: absolute;
    }
    div.message-group span.time {
        color: var(--sd-gray-d10);
        font-size: 12px;
        margin-left: 5px;
    }
    #chat-input {
        left: 50%;
        transform: translateX(-50%);
        bottom: 15px;
        padding: 10px;
        width: calc(100% - 40px);
        position: absolute;
        border-radius: 8px;
        background-color: var(--sd-black-d10);
    }
    #chat-input > input {
        width: 100%;
        border: none;
        outline: none;
        color: var(--sd-white);
        background: transparent;
    }
    #message-contain {
        overflow-y: scroll;
        padding: 20px;
        padding-left: 45px;
        max-height: calc(100% - 80px);

        /* Scrollbar */
        scrollbar-color: var(--sd-black-d10) transparent;
        scrollbar-gutter: stable both-edges;
        scrollbar-width: thin;
    }
</style>
<div class = "server-parent">
    <div id = "server-chat">
        <div id = "message-contain" class = "d-flex gap-2 flex-column">
            <div class = "message-group">
                <img class = "icon im" src = "https://cdn.discordapp.com/avatars/633185043774177280/6a5f84397ba7b5099a84a78102305095.webp?size=80">
                <div class = "d-flex gap-2 align-items-center">
                    <b>iiPythonx</b>
                    <span class = "time">Today at 4:17 PM</span>
                </div>
                <p>some random ass text here</p>
                <p>and another line</p>
                <p>yeah i really dk what im doing but oh well</p>
                <p><a href = "https://iipython.dev">https://iipython.dev</a></p>
            </div>
            <div class = "message-group">
                <img class = "icon im" src = "https://cdn.discordapp.com/avatars/633185043774177280/6a5f84397ba7b5099a84a78102305095.webp?size=80">
                <div class = "d-flex gap-2 align-items-center">
                    <b>your momma</b>
                    <span class = "time">Today at 4:18 PM</span>
                </div>
                <p>ooga booga mf</p>
            </div>
            <div class = "message-group">
                <img class = "icon im" src = "https://cdn.discordapp.com/avatars/633185043774177280/6a5f84397ba7b5099a84a78102305095.webp?size=80">
                <div class = "d-flex gap-2 align-items-center">
                    <b>iiPythonx</b>
                    <span class = "time">Today at 4:20 PM</span>
                </div>
                <p><i>gasps</i></p>
                <p>omg 4:20 pm lmao!!!</p>
            </div>
        </div>
        <div id = "chat-input" class = "d-flex gap-2">
            <input type = "text" placeholder = "Share some thoughts...">
            <button class = "btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
                </svg>
            </button>
        </div>
    </div>
    <div id = "server-info">
        <img class = "banner" src = "https://media.discordapp.net/attachments/990375009916694548/1264376272465952871/image.png?ex=669da5aa&is=669c542a&hm=8581db9e94a248dfe7f76a614151b6904a115a5889ab32e53934a2cd867de05f&=&format=webp&quality=lossless">
        <div class = "content d-flex flex-column gap-1">
            <div class = "d-flex gap-2 align-items-center">
                <img class = "icon is" src = "https://images.unsplash.com/photo-1721404832661-658016cde3d4?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D">
                <h4>Some Random Server</h4>
            </div>
            <p>27 members, 6 online</p>
            <hr>
            <code>Hi! Welcome to Some Random Server! https://somerandomserver.com</code>
        </div>
    </div>
    <div id = "server-members">
        <h4>Members</h4>
        <hr>
        <div class = "d-flex flex-column gap-2">
            <div class = "d-flex member align-items-center">
                <img class = "icon im" src = "https://cdn.discordapp.com/avatars/633185043774177280/6a5f84397ba7b5099a84a78102305095.webp?size=80">
                <div class = "d-flex flex-column">
                    <p>iiPython</p>
                    <span>Thinking about lifeâ„¢</span>
                </div>
            </div>
            <div class = "d-flex member align-items-center">
                <img class = "icon im" src = "https://cdn.discordapp.com/avatars/461629094661062656/9b2a0b7a6f93ef8f047cd23a310c96bf.webp?size=80">
                <div class = "d-flex flex-column">
                    <p>DmmD (the real one)</p>
                    <span>ðŸ¥ž ãƒ‘ãƒ³ã‚±ãƒ¼ã‚­â„¢</span>
                </div>
            </div>
            <div class = "d-flex member align-items-center">
                <img class = "icon im" src = "https://media.tenor.com/fajm0GvKOU4AAAAM/sus.gif">
                <div class = "d-flex flex-column">
                    <p>Dwayne Johnson</p>
                    <span>ðŸª¨</span>
                </div>
            </div>
            <div class = "d-flex member align-items-center">
                <img class = "icon im" src = "https://hips.hearstapps.com/hmg-prod/images/gettyimages-1229892983-square.jpg">
                <div class = "d-flex flex-column">
                    <p>Elon Musk</p>
                    <span>murdering twitter</span>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    (async () => {
        const { auth } = nightwatch;

        // Main websocket handling
        class NightwatchWebsocket {
            constructor(url) {
                this.url = url;

                // Connect socket
                this._callbacks = {};
                this.connect();
            }

            connect() {
                if (this._interval) clearInterval(this._interval);
                this.socket = new WebSocket(`wss://${this.url}`);
                this.socket.addEventListener("message", (d) => {
                    const data = JSON.parse(d.data);
                    const callback = this._callbacks[data.callback];
                    if (callback) {
                        delete this._callbacks[data.callback];
                        return callback(data);
                    }
                    if (data.type == "message" && this.on_message) this.on_message(data);
                });
                this.socket.addEventListener("error", () => { if (this.on_error) this.on_error(); });
                this.socket.addEventListener("open", () => { if (this.connected) this.connected(); });
                this._interval = setInterval(() => { this.send_payload("ping"); }, 10000);
            }

            send_payload(type, data, callback) {
                if (!this.socket) throw new Error("Current Nightwatch websocket is not connected!");
                let payload = { data: data };
                if (callback) {
                    let callback_id = nanoid();
                    payload.callback = callback_id;
                    this._callbacks[callback_id] = callback;
                }
                this.socket.send(JSON.stringify({ type: type, ...payload }));
            }

            close() {
                this.socket.close();
            }

            // Main events
            async identify() {
                const authorization = await auth.authorize(`https://${this.url.slice(0, -8)}`);
                if (authorization.code !== 200) return console.error(`Failed to authorize server: ${authorization.data}`);
                this.send_payload("identify", {
                    auth_server: `https://${auth.server}`,
                    token: authorization.data
                });
            }

            message(content) {
                this.send_payload("message", { text: content });
            }
        }

        // Main chat loop
        if (!nightwatch.active_server) return;
        const socket = new NightwatchWebsocket(nightwatch.active_server);
        socket.on_error = () => console.error("Connection to server failed.");
        socket.connected = socket.identify;

        // Handle messages
        const chat = document.getElementById("message-contain");
        function scroll(group) {
            const newMessageHeight = group.offsetHeight + parseInt(getComputedStyle(group).marginBottom);
            const scrollOffset = chat.scrollTop + chat.offsetHeight;
            if (chat.scrollHeight - newMessageHeight <= scrollOffset + 10) chat.scrollTop = chat.scrollHeight;
        }

        const mention_regex = /(?:\s|^)@([a-z0-9-_]+?):(\S{1,254}?)(?:\s|$)/;  // Thanks DmmD :3
        socket.on_message = (payload) => {
            console.log("[Received]", payload);
            switch (payload.type) {
                case "message":
                    const message = payload.data;
    
                    // Create message element
                    const message_element = document.createElement("p");
                    message_element.innerText = message.text;
    
                    // Create new message group (if needed)
                    const last = chat.lastElementChild;
                    if (last && last.getAttribute("nightwatch-userid") === message.user.id) {
                       last.appendChild(message_element);
                       return scroll(last);
                    }
    
                    const group = document.createElement("div");
                    group.classList.add("message-group");
                    group.innerHTML = `
                        <img class = "icon im" src = "https://cdn.discordapp.com/avatars/633185043774177280/6a5f84397ba7b5099a84a78102305095.webp?size=80">
                        <div class = "d-flex gap-2 align-items-center">
                            <b>${message.user.username}</b>
                            <span class = "time">${relativeTimeFormat(message.timestamp)}</span>
                        </div>
                    `;
                    group.setAttribute("nightwatch-userid", message.user.id);
                    group.appendChild(message_element);
                    chat.appendChild(group);
                    
                    // Autoscrolling
                    scroll(group);
            }
        };

        // Handle sending messages
        const chat_input = document.querySelector("#chat-input input");
        function send_current_message() {
            const message = chat_input.value;
            if (!message.trim()) return;
            socket.message(message);
            chat_input.value = "";
        }

        chat_input.addEventListener("keydown", (e) => { if (e.key === "Enter") send_current_message(); });
        document.querySelector("#chat-input button").addEventListener("click", send_current_message);
    })();
</script>